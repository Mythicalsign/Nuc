name: Nuclei scan over Tor (Docker torproxy)

on:
  workflow_dispatch:
  # push: { branches: [ main ] }   # uncomment to run on push

jobs:
  tor-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with: { go-version: stable }

      - name: Install Nuclei & update templates
        run: |
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          nuclei -update-templates

      - name: Start Tor container
        run: |
          docker run -d --rm --name tor -p 9050:9050 dperson/torproxy:latest
          sleep 10
          curl --socks5 127.0.0.1:9050 https://check.torproject.org/api/ip

      - name: Run Nuclei through Tor
        run: |
          nuclei \
            -u "https://fetena.net" \
            -proxy socks5://127.0.0.1:9050 \
            -jsonl -o nuclei.jsonl \
            -json-export nuclei.json \
            -severity critical,high,medium \
            -rl 20 -c 5 -timeout 15 -retries 2 \
            -stats

      - name: Upload JSON reports
        uses: actions/upload-artifact@v4
        with:
          name: nuclei-tor-reports
          path: |
            nuclei.json
            nuclei.jsonl
          retention-days: 30
